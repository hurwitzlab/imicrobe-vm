# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log;
#error_log  /var/log/nginx/error.log  notice;
#error_log  /var/log/nginx/error.log  info;

pid        /run/nginx.pid;


events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    index   index.php index.html index.htm;

    upstream mojo-imicrobe {
        server 127.0.0.1:3000;
    }

    upstream mojo-ivirus {
        server 127.0.0.1:3001;
    }

    upstream mojo-icmore {
        server 127.0.0.1:3002;
    }

    upstream mojo-test {
        server 127.0.0.1:3003;
    }

    upstream mojo-muscope {
        server 127.0.0.1:3004;
    }

    upstream mojo-compass {
        server 127.0.0.1:3005;
    }

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    #
    # data.imicrobe.us (proxy to Mojolicious)
    #
    server {
        server_name data.imicrobe.us;

        rewrite ^(/iplant/.*) http://mirrors.iplantcollaborative.org/browse$1;

        location / {
            proxy_pass http://mojo-imicrobe;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    #
    # imicrobe.us (Wordpress)
    #
    server {
        server_name imicrobe.us www.imicrobe.us;
        root        /usr/local/imicrobe/wordpress;
        access_log  /var/log/nginx/imicrobe.us.access.log  main;
 
        location / {
           try_files $uri $uri/ /index.php?$args;
        }
 
        error_page 404 /404.html;
 
        error_page 500 502 503 504 /50x.html;
 
        location = /50x.html {
            root /usr/share/nginx/html;
        }
 
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }

    #
    # ivirus.us (Wordpress)
    #
    server {
        server_name ivirus.us www.ivirus.us;
        root        /usr/local/ivirus/wordpress;
        access_log  /var/log/nginx/ivirus.us.access.log  main;
 
        location / {
           try_files $uri $uri/ /index.php?$args;
        }
 
        error_page 404 /404.html;
 
        error_page 500 502 503 504 /50x.html;
 
        location = /50x.html {
            root /usr/share/nginx/html;
        }
 
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }

    #
    # data.ivirus.us (proxy to Mojolicious)
    #
    server {
        server_name data.ivirus.us;
        location / {
            proxy_pass http://mojo-ivirus;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    #
    # hurwitzlab.org (Wordpress)
    #
    server {
        server_name hurwitzlab.org www.hurwitzlab.org;
        root        /usr/local/hurwitzlab/wordpress;
        access_log  /var/log/nginx/hurwitzlab.org.access.log  main;
        include     global/wordpress.conf;

        location / {
            try_files $uri $uri/ /index.php?$args;
        }

        error_page 404 /404.html;

        error_page 500 502 503 504 /50x.html;

        location = /50x.html {
            root /usr/share/nginx/html;
        }

        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }

    #
    # Hurwitz Lab MediaWiki
    #
    server {
      server_name wiki.hurwitzlab.org;
      root        /usr/local/hurwitzlab/mediawiki;

      location / {
        index index.php5;
        error_page 404 = @mediawiki;
      }

      location @mediawiki {
        rewrite ^/wiki([^?]*)(?:\?(.*))? /index.php5?title=$1&$2 last;
      }

      location ~ \.php5?$ {
        include /etc/nginx/fastcgi_params;
        fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
        fastcgi_index index.php5;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      }
    }

    server {
        server_name icmore.hawaii.edu;
        root        /usr/local/cmore/wordpress;
        access_log  /var/log/nginx/cmore.access.log  main;
        include     global/wordpress.conf;

        location / {
            try_files $uri $uri/ /index.php?$args;
        }

        error_page 404 /404.html;

        error_page 500 502 503 504 /50x.html;

        location = /50x.html {
            root /usr/share/nginx/html;
        }

        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }

    #
    # muSCOPE Wordpress
    #
    server {
         #server_name docs.muscope.org;
         server_name www.muscope.org muscope.org;
         root        /usr/local/muscope/wordpress;
         access_log  /var/log/nginx/muscope.access.log main;
         include     global/wordpress.conf;
 
         location / {
             try_files $uri $uri/ /index.php?$args;
         }
 
         error_page 404 /404.html;
 
         error_page 500 502 503 504 /50x.html;
 
         location = /50x.html {
             root /usr/share/nginx/html;
         }
 
         location ~ \.php$ {
             try_files $uri =404;
             fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
             fastcgi_index index.php;
             fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
             include fastcgi_params;
         }
    }

    #
    # muscope.org (Mojolicious)
    #
    server {
        server_name  data.muscope.org;
        #server_name  www.muscope.org muscope.org;

        rewrite ^(/iplant/.*) http://mirrors.iplantcollaborative.org/browse$1;

        location / {
            auth_basic           "SCOPE only";
            auth_basic_user_file conf/muscope.htpasswd;
            proxy_pass http://mojo-muscope;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    #
    # data.icmore.hawaii.edu (proxy to Mojolicious)
    #
    server {
        server_name data.icmore.hawaii.edu;

        rewrite ^(/iplant/.*) http://mirrors.iplantcollaborative.org/browse$1;

        location / {
            proxy_pass http://mojo-icmore;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    server {
        server_name mmmbiome.org;
        root        /usr/local/mmmbiome/wordpress;
        access_log  /var/log/nginx/mmmbiome.access.log  main;
        include     global/wordpress.conf;

        location / {
            try_files $uri $uri/ /index.php?$args;
        }

        error_page 404 /404.html;

        error_page 500 502 503 504 /50x.html;

        location = /50x.html {
            root /usr/share/nginx/html;
        }

        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }

    #
    # test.hurwitzlab.org (Compass)
    #
    server {
        server_name test.hurwitzlab.org;
        root        /usr/local/jbrowse;
    }

#     server {
#         server_name test.hurwitzlab.org;
#         location / {
#             auth_basic           "closed site";
#             auth_basic_user_file conf/compass.htpasswd;
#             proxy_pass http://mojo-compass;
#             proxy_buffering off;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection "upgrade";
#             proxy_set_header Host $host;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#         }
#     }

#     #
#     # test.hurwitzlab.org 
#     #
#     server {
#         server_name test.hurwitzlab.org;
# 
#         rewrite ^(/iplant/.*) http://mirrors.iplantcollaborative.org/browse$1;
# 
#         location / {
#             proxy_pass http://mojo-test;
#             proxy_buffering off;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection "upgrade";
#             proxy_set_header Host $host;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#         }
#     }

    server {
        server_name vervenet.us;
        return 301 $scheme://www.protocols.io/g/verve-net;
    }
}
