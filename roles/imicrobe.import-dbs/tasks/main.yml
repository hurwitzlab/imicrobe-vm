---
- name: install MySQL-python for ansible
  package:
    name: MySQL-python
    state: latest

# grant all on `imicrobe`.* to `imicrobe`@localhost identified by '<password>';
- name: Create imicrobe database user
  mysql_user:
    name: imicrobe
    password: "{{ imicrobe_mysql_pw }}"
    priv: "*.*:ALL"
    state: present

- name: Download imicrobe database dump to VM 
  get_url:
    url: ftp://ftp.imicrobe.us/database/imicrobe-2017-05-04.sql.gz
    dest: /tmp/

#- name: Copy imicrobe database dump to VM
#  copy:
#    src: files/imicrobe_dump.sql
#    dest: /tmp/

- name: Import imicrobe database
  mysql_db:
    name: imicrobe
    state: import
    target: /tmp/imicrobe-2017-05-04.sql.gz

- name: Start the mongod service (there is an Ansible handler for this but I need mongo running now)
  service:
    name: mongod
    state: started

- name: use 'localhost' for the mongo host
  lineinfile:
    dest: /home/imicrobe/imicrobe/lib/conf/imicrobe.yaml
    regexp: "  host:"
    line: "  host: \"localhost\""

- name: Build the mongo database
  shell: IMICROBE_CONF=/home/imicrobe/imicrobe/lib/conf/imicrobe.yaml perl scripts/load-search.pl
  args:
    chdir: /home/imicrobe/imicrobe/lib
  become_user: imicrobe
